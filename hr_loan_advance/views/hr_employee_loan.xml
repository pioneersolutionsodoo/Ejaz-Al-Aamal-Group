<?xml version="1.0" ?>
<odoo>
    <data>
        <!-- HR Loan-->
        <record id="view_hr_employee_loan_filter_ps" model="ir.ui.view">
            <field name="name">Loans</field>
            <field name="model">hr.employee.loan.ps</field>
            <field name="arch" type="xml">
                <search string="Loans">
                    <field name="name"/>
                    <field name="employee_id"/>
                    <field name="contract_id"/>
                    <field name="type_id"/>
                    <filter icon="terp-camera_test" domain="[('state','=','request')]"
                            string="Waiting for Direct Manager approval" name="request"/>
                    <filter icon="terp-camera_test" domain="[('state','=','progress')]"
                            string="Waiting for HR Manager approval" name="progress"/>
                    <filter icon="terp-camera_test" domain="[('state','=','progress2')]"
                            string="Waiting for finance Manager approval" name="progress2"/>

                    <filter name="state" icon="terp-document-new" string="Approved" domain="[('state','=','approve')]"
                            help="Approved"/>
                    <filter name="state" icon="terp-document-new" string="Refused" domain="[('state','=','refuse')]"
                            help="Refused"/>
                    <filter icon="terp-document-new" string="Loan for Guaranty Approval"
                            domain="[('state','=','request')]" name="guaranty"/>
                    <group expand="0" string="Group By">
                        <filter name="state" string="Employee" icon="terp-personal" domain="[]"
                                context="{'group_by':'employee_id'}"/>
                        <filter name="state" string="Contract" icon="terp-personal" domain="[]"
                                context="{'group_by':'contract_id'}"/>
                        <filter name="state" string="Loan Type" icon="terp-personal+" domain="[]"
                                context="{'group_by':'type_id'}"/>
                        <filter string="States" name="state" icon="terp-stock_effects-object-colorize"
                                context="{'group_by':'state'}"/>
                    </group>
                </search>
            </field>
        </record>

        <record id="view_hr_employee_loan_tree_ps" model="ir.ui.view">
            <field name="name">hr.employee.loan.tree.ps</field>
            <field name="model">hr.employee.loan.ps</field>
            <field name="arch" type="xml">
                <tree string="Loans">
                    <field name="name"/>
                    <field name="employee_id"/>
                    <field name="contract_id"/>
                    <field name="loan_amount"/>
                    <field name="loan_month_ins"/>
                    <field name="loan_ins_start_date"/>
                    <field name="paid_amount"/>
                    <field name="balance_amount"/>
                    <field name="paid_installment"/>
                    <field name="unpaid_installment"/>
                    <field name="state"/>
                </tree>
            </field>
        </record>

        <record id="view_hr_employee_loan_form_ps" model="ir.ui.view">
            <field name="name">hr.employee.loan.form.ps</field>
            <field name="model">hr.employee.loan.ps</field>
            <field name="arch" type="xml">
                <form string="HR Employee Loan">
                    <header>
                        <!--<button string="Send Request" name="action_request" states="draft" type="object"/>
                        <button string="Guarantor Confirm"
                                name="action_guarantor_approve"
                                class="oe_highlight"
                                icon="gtk-yes"
                                attrs="{'invisible':['|',('current_user', '=', False),('state','!=','request')]}"
                                type="object"/>
                        <button string="Progress Loan"
                                name="action_progress"
                                states="guarantor_approve"
                                type="object" groups="hr.group_hr_manager"/>
                        <button string="Progress Loan" name="action_progress"
                                type="object"
                                attrs="{'invisible':['|',('guarantor_id', '!=', False),('state','!=','request')]}"
                                groups="hr.group_hr_manager"/>
                        <button string="Approve" name="action_approve" states="progress" type="object"
                                groups="account.group_account_manager"/>-->
                        <button string="Close Loan Manually"
                                name="manual_closing_loan"
                                groups="account.group_account_manager"
                                type="object" attrs="{'invisible':[('loan_manual_closing','=',True)]}"/>
                        <button string="Request For DM Approval"
                                name="action_request"
                                type="object" states="draft"/>
                        <button string="Guarantor Confirm"
                                name="action_guarantor_approve"
                                class="oe_highlight"
                                icon="gtk-yes"
                                attrs="{'invisible':['|',('current_user', '=', False),('state','!=','request')]}"
                                type="object"/>
                        <button string="DM Approve"
                                name="action_progress"
                                type="object" help="First Phase Approval"
                                attrs="{'invisible':[('is_show_dm_approve', '=', False)]}"/>
                        <button string="HR Manager Approve"
                                name="action_progress2"
                                type="object" help="Second Phase Approval"
                                attrs="{'invisible':[('is_show_hrm_approve', '=', False)]}"/>
                        <button string="FM Approve"
                                help="Finance Manager Approval"
                                name="action_approve" type="object"
                                attrs="{'invisible':[('is_show_fm_approve', '=', False)]}"/>
                        <button string="Admin &amp; Financial Director approval"
                                name="action_progress3"
                                type="object" help="Admin &amp; Financial Director approval"
                                attrs="{'invisible':[('is_show_admin_approve', '=', False)]}"/>
                        <button string="Back to Draft" name="action_draft"
                                states="request,guarantor_approve,progress,progress2"
                                groups="hr.group_hr_manager,account.group_account_manager" type="object"/>
                        <button string="Refuse" name="action_refuse" states="request" type="object"
                                groups="hr.group_hr_manager"/>
                        <button string="Refuse" name="action_refuse" type="object"
                                attrs="{'invisible':['|',('current_user', '=', False),('state','!=','request')]}"/>
                        <button string="Refuse" name="action_refuse" type="object"
                                states="guarantor_approve" groups="hr.group_hr_manager"/>
                        <button string="Refuse" name="action_refuse" states="progress,progress2" type="object"
                                groups="account.group_account_manager"/>
                        <button type="object" name="compute_installment_board" string="Compute Installment"
                                colspan="2" states="progress,progress2,progress3"/>
                        <field name="state" readonly="True" widget="statusbar" statusbar_visible="draft,approve"
                               statusbar_colors='{"draft":"red"}'/>
                    </header>
                    <sheet>
                        <div class="oe_title">
                            <h1>
                                <field name="name" readonly="1"/>
                            </h1>
                        </div>
                        <group>
                            <group string="Request Details" required="1">
                                <field name="employee_id" attrs="{'readonly':[('state','not in',('draft',False))]}"
                                />
                                <field name="type_id" required="1" attrs="{'readonly':[('state','not in',('draft',False))]}"/>
                                <field name="guarantor_id" domain="[('id','!=',employee_id)]"/>
                            </group>
                            <group>
                                <field name="contract_id" domain="[('employee_id','=',employee_id)]"
                                       attrs="{'readonly':[('state','not in',('draft',False))]}"/>
                                <field name="loan_amount_required" required="1"
                                       attrs="{'readonly':[('state','not in',('draft',False))]}"/>
                                <field name="request_date" readonly="1"
                                       attrs="{'invisible':[('request_date','=',False)]}"/>
                                <field name="loan_manual_closing" invisible='1'/>
                                <field name="loan_manual_closing_id"
                                       readonly="1" string="Manual Closing Entry"
                                       attrs="{'invisible':[('state','!=','approve')]}"/>
                            </group>
                        </group>
                        <field name="current_user" invisible='1'/>
                        <field name="loan_open" invisible="1"/>
                        <field name="currency_id" invisible="1" required="1"/>
                        <field name="warning" class="hr_loan_advance_warning" readonly="1"
                               attrs="{'invisible':[('state','not in',('progress2','progress','approve'))]}"/>
                        <notebook>
                            <page string="Approval Details"
                                  attrs="{'invisible':[('state','in',('draft','refused'))]}">
<!--                                  attrs="{'invisible':[('state','not in',('progress2','progress','approve'))]}">-->
                                <group col="4">
                                    <field name="old_loan_remaining"/>
                                    <field name="loan_amount"
                                           attrs="{'readonly':[('state','in',('approve','refuse'))]}"/>
                                    <field name="account_manager_id" readonly="1"
                                           attrs="{'invisible':[('account_manager_id','=',False)]}"/>
                                    <field name="allow_another_loan"
                                           attrs="{'invisible':[('old_loan_remaining','&lt;=',0)],'readonly':[('state','in',('approve','refuse'))]}"/>
                                    <field name="is_direct_manager" invisible='1'/>
                                    <field name="is_coach" invisible='1'/>
                                    <field name="loan_month_ins"
                                           attrs="{'readonly':[('state','in',('approve','refuse'))]}"/>
                                    <field name="loan_ins_start_date"
                                           attrs="{'readonly':[('state','in',('approve','refuse'))]}"/>
                                    <field name="move_id" readonly="1" attrs="{'invisible':[('move_id','=',False)]}"/>
                                    <field name="account_manager_date" readonly="1"
                                           attrs="{'invisible':[('account_manager_date','=',False)]}"/>
                                    <field name="company_id" groups="base.group_multi_company" readonly="1" required="1"/>
                                    <field name="is_show_dm_approve" invisible="1"/>
                                    <field name="is_show_hrm_approve" invisible="1"/>
                                    <field name="is_show_fm_approve" invisible="1"/>
                                    <field name="is_show_admin_approve" invisible="1"/>
                                </group>
                            </page>
                            <page string="Payment Scheduler"
                                  attrs="{'invisible':[('state','not in',('progress2','progress','approve'))]}">
                                <field name="hr_employee_loan_line_ps" colspan="4" string="Loan List" nolabel="1">
                                    <tree string="Loan Lines" editable="bottom"
                                          colors="blue:(state == 'notdeducted');black:(state == 'deducted')">
                                        <field name="sequence" invisible="1"/>
                                        <field name="name"/>
                                        <field name="installment_date"/>
                                        <field name="installment_value"/>
                                        <field name="amount"/>
                                        <field name="remaining_value"/>
                                        <field name="confirm"/>
                                        <field name="state" readonly="False"/>
                                    </tree>
                                </field>


                                <group class="oe_subtotal_footer oe_right" colspan="2">
                                    <field name="total_amount" invisible="1"/>
                                    <field name="paid_amount" invisible="1"/>
                                    <field name="balance_amount"/>
                                    <field name="paid_installment" invisible="1"/>
                                    <field name="unpaid_installment" invisible="1"/>
                                </group>

                            </page>
                            <page string="Approval Notes">
                                <group>
                                    <group>
                                        <field name="direct_manager_id" readonly="1"/>
                                        <field name="d_manager_note" nolabel="1" placeholder="Direct Manager Note"
                                               attrs="{'readonly':[('state','!=','request')]}"/>
                                        <field name="hr_manager_id" readonly="1"/>
                                        <field name="hr_manage_note" nolabel="1" placeholder="HR Manager Note"
                                               attrs="{'readonly':[('state','!=','progress')]}"/>
                                    </group>
                                    <group>
                                        <field name="account_manager_id" readonly="1"/>
                                        <field name="account_manage_note" nolabel="1" placeholder='Admin Manager Note'
                                               attrs="{'readonly':[('state','!=','progress2')]}"/>
                                        <field name="admin_manager_id" readonly="1"/>
                                        <field name="admin_manager_note" nolabel="1"
                                               placeholder="Accounting Manager Note"
                                               attrs="{'readonly':[('state','!=','progress3')]}"/>
                                    </group>
                                </group>

                            </page>
                        </notebook>

                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers" groups="base.group_user"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>

        <!--ACTION-->
        <!--MY LOAN REQUEST-->
        <record id="open_hr_employee_loan_ps" model="ir.actions.act_window">
            <field name="name">My Loan Request</field>
            <field name="res_model">hr.employee.loan.ps</field>

            <field name="view_mode">tree,form</field>
            <field name="domain">[('employee_id.user_id','=',uid)]</field>
            <field name="context">{'my_loan_request':True,'user': 'user_id'
                ,'cond': 'in','val': uid}
            </field>
            <field name="view_id" eval="view_hr_employee_loan_tree_ps"/>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    Click to add a new Loan.
                </p>
            </field>
        </record>


        <!--LOAN FOR GUARANTOR APPROVAL-->
        <record id="open_hr_employee_loan_ps_my_guaranty" model="ir.actions.act_window">
            <field name="name">Loan for Guaranty Approval</field>
            <field name="res_model">hr.employee.loan.ps</field>
            <field name="type">ir.actions.act_window</field>

            <field name="view_mode">tree,form</field>
            <field name="domain">[('guarantor_id.user_id', 'in', [uid])]</field>
            <field name="context">{'my_guaranty_loan_request':True,'user': 'guarantor_id.user_id'
                ,'cond': 'in','val':uid,'search_default_guaranty':1}
            </field>
            <field name="view_id" eval="view_hr_employee_loan_tree_ps"/>
            <field name="search_view_id" ref="view_hr_employee_loan_filter_ps"/>
        </record>


        <!--DM APPROVAL-->
        <record id="open_hr_employee_loan_ps_direct" model="ir.actions.act_window">
            <field name="name">Direct MGR Approval</field>
            <field name="res_model">hr.employee.loan.ps</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('employee_id.parent_id.user_id', 'in', [uid])]</field>
            <field name="context">{'my_dm_loan_request':True,'user': 'parent_id.user_id'
                ,'cond': 'in','val':uid,'search_default_request':1}
            </field>
            <field name="view_id" eval="False"/>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    Click to add a new Loan.
                </p>
            </field>
        </record>

        <!--HRM APPROVAL-->
        <record id="open_hr_employee_loan_ps_hrm" model="ir.actions.act_window">
            <field name="name">HR MGR Approval</field>
            <field name="res_model">hr.employee.loan.ps</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[]</field>
            <field name="context">{'my_hrm_loan_request':True,'user': 'id'
                ,'cond': 'not in','val': False,'search_default_progress':1}
            </field>
            <field name="view_id" eval="False"/>
        </record>

        <!--FM APPROVAL-->
        <record id="open_hr_employee_loan_ps_all" model="ir.actions.act_window">
            <field name="name">Finance MGR Approval</field>
            <field name="res_model">hr.employee.loan.ps</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('state','not in',('draft',False))]</field>
            <field name="context">{'my_fm_loan_request':True, 'user': 'id'
                ,'cond': 'not in','val': False,'search_default_progress2':1}
            </field>
            <field name="view_id" eval="view_hr_employee_loan_tree_ps"/>
        </record>

        <!--Admin & Financial Director APPROVAL-->
        <record id="open_hr_employee_loan_ps_admin" model="ir.actions.act_window">
            <field name="name">Admin &amp; FD Approval</field>
            <field name="res_model">hr.employee.loan.ps</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('state','=','progress3')]</field>
            <field name="context">{'my_fd_loan_request':True, 'user': 'id'
                ,'cond': 'not in','val': False,'search_default_progress3':1}
            </field>
            <field name="view_id" eval="view_hr_employee_loan_tree_ps"/>
        </record>
    </data>
</odoo>
